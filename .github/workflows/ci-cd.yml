name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: docker.io
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/multitenant-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/multitenant-frontend

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          apps/backend/package-lock.json
          apps/frontend/package-lock.json

    - name: Ensure DATABASE_URL (fallback to service)
      run: |
        if [ -z "${{ env.DATABASE_URL }}" ]; then
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_db" >> $GITHUB_ENV
          echo "Using local Postgres service for tests"
        else
          echo "Using DATABASE_URL from secrets"
        fi

    - name: Wait for Postgres to be ready
      run: |
        for i in $(seq 1 30); do
          pg_isready -h localhost -p 5432 -U postgres && break
          echo "Waiting for Postgres..."
          sleep 2
        done

    - name: Install backend dependencies (safe)
      run: |
        cd apps/backend
        if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
          npm ci
        else
          npm install
        fi

    - name: Install frontend dependencies (safe)
      run: |
        cd apps/frontend
        if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
          npm ci
        else
          npm install
        fi

    - name: Generate Prisma Client (Check Version)
      run: |
        cd apps/backend
        echo "Checking local prisma version..."
        if [ -f node_modules/prisma/package.json ]; then
            node -e "console.log('Local prisma version:', require('./node_modules/prisma/package.json').version)"
        else
            echo "Local prisma not found in node_modules"
        fi
        npm run prisma:generate

    - name: Run backend lint
      run: |
        cd apps/backend
        npm run lint --if-present

    - name: Run frontend lint
      run: |
        cd apps/frontend
        npm run lint --if-present

    - name: Run security audit (non-blocking)
      run: |
        cd apps/backend || exit 0
        npm audit --audit-level=moderate || true
        cd ../frontend || exit 0
        npm audit --audit-level=moderate || true

    - name: Run backend tests (if present)
      run: |
        cd apps/backend
        npm run test --if-present

    - name: Run frontend tests (if present)
      run: |
        cd apps/frontend
        npm run test --if-present

  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'

    steps:
    - uses: actions/checkout@v4

    - name: Extract metadata
      id: meta
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          VERSION="${{ github.ref_name }}"
          SHA=${GITHUB_SHA::8}
          BACKEND_TAGS="${BACKEND_IMAGE}:${VERSION},${BACKEND_IMAGE}:sha-${SHA}"
          FRONTEND_TAGS="${FRONTEND_IMAGE}:${VERSION},${FRONTEND_IMAGE}:sha-${SHA}"
        else
          VERSION="latest"
          BACKEND_TAGS="${BACKEND_IMAGE}:${VERSION}"
          FRONTEND_TAGS="${FRONTEND_IMAGE}:${VERSION}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "backend_tags=${BACKEND_TAGS}" >> $GITHUB_OUTPUT
        echo "frontend_tags=${FRONTEND_TAGS}" >> $GITHUB_OUTPUT

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Validate Docker Hub secrets
      run: |
        echo "üîç Validating Docker Hub secrets..."
        if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
          echo "‚ùå ERROR: DOCKERHUB_USERNAME secret is missing or empty"
          exit 1
        fi
        if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
          echo "‚ùå ERROR: DOCKERHUB_TOKEN secret is missing or empty"
          exit 1
        fi
        echo "‚úÖ Docker Hub secrets found"

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push backend image
      uses: docker/build-push-action@v5
      with:
        context: ./apps/backend
        push: true
        tags: ${{ steps.meta.outputs.backend_tags }}
        labels: |
          org.opencontainers.image.title=Multitenant Backend
          org.opencontainers.image.description=NestJS backend for multitenant system
          org.opencontainers.image.version=${{ steps.meta.outputs.version }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}

    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./apps/frontend
        push: true
        tags: ${{ steps.meta.outputs.frontend_tags }}
        labels: |
          org.opencontainers.image.title=Multitenant Frontend
          org.opencontainers.image.description=Next.js frontend for multitenant system
          org.opencontainers.image.version=${{ steps.meta.outputs.version }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}