name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'  # S√≥ roda em push, n√£o em PR

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install backend dependencies
      run: |
        cd apps/backend
        npm ci

    - name: Install frontend dependencies
      run: |
        cd apps/frontend
        npm ci

    - name: Generate Prisma Client
      run: |
        cd apps/backend
        npm run prisma:generate

    - name: Run backend lint
      run: |
        cd apps/backend
        npm run lint

    - name: Run frontend lint
      run: |
        cd apps/frontend
        npm run lint

    - name: Run security audit
      run: |
        cd apps/backend
        npm audit --audit-level=moderate || true
        cd ../frontend
        npm audit --audit-level=moderate || true

    - name: Run tests (when implemented)
      run: |
        echo "Tests will be added when test suite is implemented"

  build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # S√≥ roda em push para main

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Validate Docker Hub secrets
      run: |
        echo "üîç Validating Docker Hub secrets..."

        # Check if secrets exist and are not empty
        if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
          echo "‚ùå ERROR: DOCKER_USERNAME secret is missing or empty"
          echo "üìù Please create DOCKER_USERNAME secret in GitHub repository settings"
          exit 1
        fi

        if [ -z "${{ secrets.DOCKER_TOKEN }}" ]; then
          echo "‚ùå ERROR: DOCKER_TOKEN secret is missing or empty"
          echo "üìù Please create DOCKER_TOKEN secret in GitHub repository settings"
          exit 1
        fi

        # Validate username format (Docker Hub usernames are lowercase, alphanumeric, underscores, hyphens)
        if ! echo "${{ secrets.DOCKER_USERNAME }}" | grep -qE '^[a-z0-9_-]+$'; then
          echo "‚ùå ERROR: DOCKER_USERNAME format is invalid"
          echo "üìù Docker Hub usernames should be lowercase, alphanumeric with underscores/hyphens"
          exit 1
        fi

        # Validate token format (Docker Hub tokens are long alphanumeric strings)
        if [ ${#DOCKER_TOKEN} -lt 20 ]; then
          echo "‚ùå ERROR: DOCKER_TOKEN appears to be too short"
          echo "üìù Docker Hub tokens should be long alphanumeric strings"
          exit 1
        fi

        echo "‚úÖ All Docker Hub secrets are valid and available"
        echo "üîê Username: ${{ secrets.DOCKER_USERNAME }}"
        echo "üîë Token length: ${#DOCKER_TOKEN} characters"

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Build and push backend image
      uses: docker/build-push-action@v4
      with:
        context: ./apps/backend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/multitenant-backend:latest
        labels: |
          org.opencontainers.image.title=Multitenant Backend
          org.opencontainers.image.description=NestJS backend for multitenant system
          org.opencontainers.image.source=https://github.com/gorinformaticadev/Projeto-menu-multitenant-seguro

    - name: Build and push frontend image
      uses: docker/build-push-action@v4
      with:
        context: ./apps/frontend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/multitenant-frontend:latest
        labels: |
          org.opencontainers.image.title=Multitenant Frontend
          org.opencontainers.image.description=Next.js frontend for multitenant system
          org.opencontainers.image.source=https://github.com/gorinformaticadev/Projeto-menu-multitenant-seguro

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to production
      run: |
        echo "Deployment steps would go here"
        echo "This would typically involve:"
        echo "1. Connecting to production server"
        echo "2. Pulling latest images"
        echo "3. Running docker-compose up -d"