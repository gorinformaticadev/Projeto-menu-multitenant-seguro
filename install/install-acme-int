#!/usr/bin/env bash

# ============================================================================
# install-acme-int - Instalador com Nginx INTERNO (Docker)
# ============================================================================
# Este script instala o Projeto-menu-multitenant-seguro usando Nginx
# dentro do Docker (nginx-proxy + acme-companion).
# É 100% compatível com o ticketz-docker-acme.
#
# Uso:
#   sudo bash install/install-acme-int <domain> <email>
# ============================================================================

set -Eeuo pipefail
IFS=$'\n\t'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Variáveis padrão
DOMAIN="${1:-}"
EMAIL="${2:-}"
FRONTEND_PORT="3000" # Porta interna do container
APP_NAME="multitenant"
INSTALL_DIR="/opt/multitenant"

# Cores para output
echoblue() { echo -ne "\033[44m\033[37m\033[1m  $1  \033[0m\n"; }
echored() { echo -ne "\033[41m\033[37m\033[1m  $1  \033[0m\n"; }
echogreen() { echo -ne "\033[42m\033[37m\033[1m  $1  \033[0m\n"; }
log_info() { echo -e "\033[1;34m[INFO]\033[0m $*"; }
log_warn() { echo -e "\033[1;33m[WARN]\033[0m $*"; }
log_error() { echo -e "\033[1;31m[ERROR]\033[0m $*" >&2; }

show_usage() {
    cat <<'EOF'
Uso:
  sudo bash install/install-acme-int <domain> <email>

Exemplo:
  sudo bash install/install-acme-int menu.exemplo.com.br admin@exemplo.com.br
EOF
}

require_root() {
    if [[ $EUID -ne 0 ]]; then
        echored "Este script deve ser executado como root"
        exit 1
    fi
}

validate_params() {
    if [[ -z "$DOMAIN" || -z "$EMAIL" ]]; then
        echored "Parâmetros obrigatórios faltando!"
        show_usage
        exit 1
    fi
}

ensure_docker() {
    if ! command -v docker >/dev/null 2>&1; then
        log_info "Docker não encontrado. Instalando..."
        curl -fsSL https://get.docker.com | sh
    fi
}

detect_existing_proxy() {
    log_info "Detectando stack nginx-proxy existente..."
    local proxy_containers
    proxy_containers="$(docker ps --format '{{.Names}}' | grep -E 'nginx-proxy|ticketz-nginx-proxy' || true)"

    if [[ -n "$proxy_containers" ]]; then
        log_info "Stack existente encontrado: $proxy_containers"
        export EXISTING_PROXY="true"
        export PROXY_NETWORK="nginx-proxy"
    else
        export EXISTING_PROXY="false"
    fi
}

prepare_install_dir() {
    log_info "Preparando diretório: $INSTALL_DIR"
    mkdir -p "$INSTALL_DIR"
    rsync -av --exclude='.git' "$PROJECT_ROOT/" "$INSTALL_DIR/"
    cd "$INSTALL_DIR"
}

setup_env_file() {
    log_info "Configurando .env..."
    cp "$INSTALL_DIR/.env.example" "$INSTALL_DIR/.env"
    cat >> "$INSTALL_DIR/.env" <<EOF
DOMAIN=$DOMAIN
LETSENCRYPT_EMAIL=$EMAIL
JWT_SECRET=$(openssl rand -hex 32)
ENCRYPTION_KEY=$(openssl rand -hex 32)
DB_PASSWORD=$(openssl rand -hex 16)
EOF
}

install_internal_proxy() {
    log_info "Iniciando instalação com Nginx Interno (Docker)..."
    
    # Usa o setup.sh do projeto que já lida com a lógica de nginx-proxy
    bash "$INSTALL_DIR/install/setup.sh" \
        --domain "$DOMAIN" \
        --email "$EMAIL" \
        --app-name "$APP_NAME" \
        --app-port "$FRONTEND_PORT" \
        --app-service "frontend" \
        --app-compose "$INSTALL_DIR/docker-compose.yml" \
        --app-compose "$INSTALL_DIR/docker-compose.prod.external.yml"
}

main() {
    require_root
    validate_params
    ensure_docker
    detect_existing_proxy
    prepare_install_dir
    setup_env_file
    install_internal_proxy
    
    echogreen "=============================================="
    echogreen "  INSTALAÇÃO INTERNA CONCLUÍDA!              "
    echogreen "  Acesse: https://$DOMAIN                    "
    echogreen "=============================================="
}

main "$@"
