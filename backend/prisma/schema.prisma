generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
  CLIENT
}

model Tenant {
  id              String             @id @default(uuid())
  email           String             @unique
  cnpjCpf         String             @unique
  nomeFantasia    String
  nomeResponsavel String
  telefone        String
  logoUrl         String?
  ativo           Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  users           User[]
  tenantModules   ModuleTenant[]
  publicPage      TenantPublicPage?

  // Índices para performance
  @@index([ativo]) // Filtrar tenants ativos
  @@index([createdAt]) // Ordenar por data de criação
  @@map("tenants")
}

model User {
  id                       String               @id @default(uuid())
  email                    String               @unique
  password                 String
  name                     String
  role                     Role                 @default(USER)
  tenantId                 String?
  tenant                   Tenant?              @relation(fields: [tenantId], references: [id])
  twoFactorSecret          String?
  twoFactorEnabled         Boolean              @default(false)
  // Verificação de email
  emailVerified            Boolean              @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  // Histórico de senhas (JSON array com últimos 5 hashes)
  passwordHistory          String?
  lastPasswordChange       DateTime?
  // Controle de bloqueio por tentativas de login
  loginAttempts            Int                  @default(0)
  isLocked                 Boolean              @default(false)
  lockedAt                 DateTime?
  lockedUntil              DateTime?
  lastFailedLoginAt        DateTime?
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  auditLogs                AuditLog[]
  refreshTokens            RefreshToken[]
  passwordResetTokens      PasswordResetToken[]

  // Índices para performance e segurança
  @@index([tenantId]) // Já existia - essencial para isolamento multitenant
  @@index([email]) // Busca rápida por email (login)
  @@index([role]) // Filtrar por role (RBAC)
  @@index([isLocked]) // Encontrar contas bloqueadas
  @@index([tenantId, role]) // Combinação comum: usuários de um tenant por role
  @@map("users")
}

// Tabela de Refresh Tokens
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Índices para performance de limpeza e validação
  @@index([userId]) // Já existia - buscar tokens de um usuário
  @@index([token]) // Já existia - validação rápida de token
  @@index([expiresAt]) // NOVO - limpeza de tokens expirados
  @@index([userId, expiresAt]) // NOVO - tokens ativos de um usuário
  @@map("refresh_tokens")
}

// Tabela de Tokens de Reset de Senha
model PasswordResetToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  // Índices para performance
  @@index([userId]) // Buscar tokens de um usuário
  @@index([token]) // Validação rápida de token
  @@index([expiresAt]) // Limpeza de tokens expirados
  @@index([usedAt]) // Filtrar tokens não utilizados
  @@map("password_reset_tokens")
}

// Tabela de Logs de Auditoria
model AuditLog {
  id        String   @id @default(uuid())
  action    String // LOGIN, LOGOUT, CREATE_TENANT, UPDATE_USER, etc
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  tenantId  String?
  ipAddress String?
  userAgent String?
  details   String? // JSON com detalhes adicionais
  createdAt DateTime @default(now())

  // Índices para queries de auditoria e relatórios
  @@index([userId]) // Já existia - logs de um usuário
  @@index([tenantId]) // Já existia - logs de um tenant
  @@index([action]) // Já existia - filtrar por tipo de ação
  @@index([createdAt]) // Já existia - ordenar por data
  @@index([tenantId, action, createdAt]) // NOVO - combinação comum para relatórios
  @@index([userId, action, createdAt]) // NOVO - histórico de ações do usuário
  @@map("audit_logs")
}

// Tabela de Configurações de Segurança (apenas SUPER_ADMIN pode editar)
model SecurityConfig {
  id                         String   @id @default(uuid())
  // Rate Limiting
  loginMaxAttempts           Int      @default(5) // Tentativas de login antes de bloquear
  loginLockDurationMinutes   Int      @default(30) // Duração do bloqueio em minutos
  loginWindowMinutes         Int      @default(1) // Janela de tempo em minutos
  globalMaxRequests          Int      @default(100) // Requisições globais
  globalWindowMinutes        Int      @default(1) // Janela de tempo global
  // Senha
  passwordMinLength          Int      @default(8)
  passwordRequireUppercase   Boolean  @default(true)
  passwordRequireLowercase   Boolean  @default(true)
  passwordRequireNumbers     Boolean  @default(true)
  passwordRequireSpecial     Boolean  @default(true)
  // JWT
  accessTokenExpiresIn       String   @default("15m") // 15 minutos
  refreshTokenExpiresIn      String   @default("7d") // 7 dias
  // 2FA
  twoFactorEnabled           Boolean  @default(false) // Habilitar 2FA globalmente
  twoFactorRequired          Boolean  @default(false) // Tornar 2FA obrigatório
  twoFactorRequiredForAdmins Boolean  @default(false) // 2FA obrigatório apenas para ADMIN/SUPER_ADMIN
  twoFactorSuggested         Boolean  @default(true) // Exibir avisos sugerindo ativação de 2FA
  // Email Verification
  emailVerificationRequired  Boolean  @default(false) // Exigir verificação de email
  emailVerificationLevel     String   @default("SOFT") // Nível: SOFT, MODERATE, STRICT
  // Password Policy
  passwordReuseLimit         Int      @default(5) // Prevenir reutilização das últimas N senhas
  // Sessão
  sessionTimeoutMinutes      Int      @default(30) // Timeout de inatividade em minutos (logout automático)
  // Email SMTP Credentials (único para toda a plataforma)
  smtpUsername               String? // Usuário SMTP
  smtpPassword               String? // Senha SMTP (armazenada com criptografia)
  // Configurações da Plataforma
  platformName               String?  @default("Sistema Multitenant") // Nome da plataforma
  platformEmail              String? // Email informativo da plataforma
  platformPhone              String? // Telefone de contato da plataforma
  updatedAt                  DateTime @updatedAt
  updatedBy                  String? // ID do SUPER_ADMIN que atualizou

  @@map("security_config")
}

// Tabela de Configurações de Email (apenas SUPER_ADMIN pode editar)
model EmailConfiguration {
  id           String   @id @default(uuid())
  providerName String
  smtpHost     String
  smtpPort     Int
  encryption   String
  authMethod   String
  isActive     Boolean  @default(false)
  createdBy    String?
  updatedBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("email_configurations")
}

// Tabela de Configurações do Sistema de Updates (apenas SUPER_ADMIN pode editar)
model SystemSettings {
  id                 String    @id @default(uuid())
  // Versão da aplicação
  appVersion         String?   @default("1.0.0")
  // Configurações do Git
  gitToken           String? // Token criptografado
  gitUsername        String?
  gitRepository      String?
  gitReleaseBranch   String    @default("main")
  // Configurações do sistema
  packageManager     String    @default("npm")
  updateCheckEnabled Boolean   @default(true)
  lastUpdateCheck    DateTime?
  availableVersion   String?
  updateAvailable    Boolean   @default(false)
  // Metadados
  updatedAt          DateTime  @updatedAt
  updatedBy          String? // ID do SUPER_ADMIN que atualizou

  @@map("system_settings")
}

// Tabela de Logs de Atualizações (auditoria completa)
model UpdateLog {
  id             String    @id @default(uuid())
  version        String // Versão de destino
  status         String // STARTED, SUCCESS, FAILED, ROLLED_BACK
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  duration       Int? // Duração em segundos
  // Detalhes da execução
  packageManager String    @default("npm")
  backupPath     String? // Caminho do backup criado
  errorMessage   String? // Mensagem de erro se falhou
  rollbackReason String? // Motivo do rollback
  // Auditoria
  executedBy     String? // ID do SUPER_ADMIN
  ipAddress      String?
  userAgent      String?
  // Logs detalhados (JSON)
  executionLogs  String? // Logs completos da execução

  @@index([status])
  @@index([startedAt])
  @@index([version])
  @@index([executedBy])
  @@map("update_logs")
}

// Enums para status de módulos
enum ModuleStatus {
  detected
  installed
  db_ready
  active
  disabled
}

// Enums para tipos de migration
enum MigrationType {
  migration
  seed
}

// Tabela principal de módulos
model Module {
  id          String       @id @default(uuid())
  slug        String       @unique // Slug único do módulo (ex: "sistema", "financeiro")
  name        String // Nome para exibição (ex: "Sistema", "Financeiro")
  version     String       @default("1.0.0") // Versão do módulo
  description String? // Descrição do módulo
  status      ModuleStatus @default(detected) // Estado do ciclo de vida
  hasBackend  Boolean      @default(false) // Se tem código backend
  hasFrontend Boolean      @default(false) // Se tem código frontend
  installedAt DateTime? // Quando foi instalado
  activatedAt DateTime? // Quando foi ativado
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relacionamentos
  menus       ModuleMenu[]
  tenantModules ModuleTenant[]
  migrations  ModuleMigration[]

  @@index([status])
  @@index([slug])
  @@map("modules")
}

// Tabela de menus dos módulos
model ModuleMenu {
  id         String   @id @default(uuid())
  moduleId   String
  module     Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  label      String // Texto do menu
  icon       String? // Ícone do menu
  route      String // Rota do menu
  parentId   String? // ID do menu pai (para submenus)
  parent     ModuleMenu? @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children   ModuleMenu[] @relation("MenuHierarchy") // Submenus
  order      Int      @default(0) // Ordem de exibição
  permission String? // Permissão necessária
  isUserMenu Boolean  @default(true) // Se aparece no menu do usuário
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([moduleId])
  @@index([parentId])
  @@index([order])
  @@map("module_menus")
}

// Tabela de módulos por tenant
model ModuleTenant {
  id       String  @id @default(uuid())
  moduleId String
  module   Module  @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  enabled  Boolean @default(false) // Se o módulo está habilitado para este tenant
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([moduleId, tenantId])
  @@index([tenantId])
  @@index([moduleId])
  @@index([enabled])
  @@map("module_tenant")
}

// Tabela de migrations dos módulos
model ModuleMigration {
  id         String        @id @default(uuid())
  moduleId   String
  module     Module        @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  filename   String // Nome do arquivo de migration/seed
  type       MigrationType // migration ou seed
  executedAt DateTime? // Quando foi executado
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@unique([moduleId, filename, type])
  @@index([moduleId])
  @@index([type])
  @@index([executedAt])
  @@map("module_migrations")
}

// Tabela de Notificações
model Notification {
  id        String    @id @default(uuid())
  title     String // Título da notificação
  message   String // Mensagem da notificação
  severity  String // info, warning, critical
  audience  String // user, admin, super_admin
  source    String // core, module
  module    String? // Slug do módulo (se source = module)
  tenantId  String? // ID do tenant (null = global)
  userId    String? // ID do usuário específico (null = todos da audiência)
  context   String? // URL para redirecionamento
  data      String    @default("{}") // Dados extras em JSON
  read      Boolean   @default(false) // Se foi lida
  readAt    DateTime? // Quando foi lida
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Índices para performance
  @@index([tenantId])
  @@index([userId])
  @@index([audience])
  @@index([severity])
  @@index([source])
  @@index([module])
  @@index([read])
  @@index([createdAt])
  @@index([tenantId, audience, read]) // Consultas comuns
  @@index([userId, read]) // Notificações não lidas do usuário
  @@map("notifications")
}

// Tabela de páginas públicas por tenant
model TenantPublicPage {
  id          String  @id @default(uuid())
  tenantId    String  @unique
  tenant      Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  title       String  @default("Página Institucional") // Título da página
  subtitle    String? // Subtítulo
  description String? // Descrição da empresa/tenant
  content     String? // Conteúdo HTML da página
  logoUrl     String? // URL do logo
  bannerUrl   String? // URL do banner
  contactInfo String? // Informações de contato em JSON
  socialLinks String? // Links sociais em JSON
  isActive    Boolean @default(false) // Se a página está ativa
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([isActive])
  @@map("tenant_public_pages")
}


// ============================================
// MÓDULO DEMO-COMPLETO - TABELAS
// ============================================

enum DemoStatus {
  draft
  published
  archived
}

// Tabela principal de demonstrações
model Demo {
  id          String               @id @default(uuid())
  tenantId    String
  title       String
  description String?
  content     String?
  status      DemoStatus           @default(draft)
  priority    Int                  @default(0)
  viewsCount  Int                  @default(0)
  likesCount  Int                  @default(0)
  createdBy   String?
  updatedBy   String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  deletedAt   DateTime?
  categories  DemoCategoryRelation[]
  tags        DemoTagRelation[]
  attachments DemoAttachment[]
  comments    DemoComment[]
  activities  DemoActivity[]

  @@index([tenantId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("demos")
}

// Tabela de categorias
model DemoCategory {
  id         String                 @id @default(uuid())
  tenantId   String
  name       String
  slug       String
  description String?
  color      String?
  icon       String?
  orderIndex Int                    @default(0)
  isActive   Boolean                @default(true)
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt
  demos      DemoCategoryRelation[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([slug])
  @@index([isActive])
  @@map("demo_categories")
}

// Tabela de tags
model DemoTag {
  id         String            @id @default(uuid())
  tenantId   String
  name       String
  slug       String
  color      String?
  usageCount Int               @default(0)
  createdAt  DateTime          @default(now())
  demos      DemoTagRelation[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([slug])
  @@index([usageCount(sort: Desc)])
  @@map("demo_tags")
}

// Relacionamento demos <-> categories (many-to-many)
model DemoCategoryRelation {
  demoId     String
  demo       Demo         @relation(fields: [demoId], references: [id], onDelete: Cascade)
  categoryId String
  category   DemoCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt  DateTime     @default(now())

  @@id([demoId, categoryId])
  @@index([demoId])
  @@index([categoryId])
  @@map("demo_category_relations")
}

// Relacionamento demos <-> tags (many-to-many)
model DemoTagRelation {
  demoId    String
  demo      Demo     @relation(fields: [demoId], references: [id], onDelete: Cascade)
  tagId     String
  tag       DemoTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([demoId, tagId])
  @@index([demoId])
  @@index([tagId])
  @@map("demo_tag_relations")
}

// Tabela de anexos/arquivos
model DemoAttachment {
  id               String   @id @default(uuid())
  demoId           String
  demo             Demo     @relation(fields: [demoId], references: [id], onDelete: Cascade)
  filename         String
  originalFilename String
  mimeType         String
  sizeBytes        BigInt
  storagePath      String
  thumbnailPath    String?
  uploadedBy       String?
  createdAt        DateTime @default(now())

  @@index([demoId])
  @@index([mimeType])
  @@map("demo_attachments")
}

// Tabela de comentários
model DemoComment {
  id        String         @id @default(uuid())
  demoId    String
  demo      Demo           @relation(fields: [demoId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    DemoComment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   DemoComment[]  @relation("CommentReplies")
  userId    String
  content   String
  isEdited  Boolean        @default(false)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  deletedAt DateTime?

  @@index([demoId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt(sort: Desc)])
  @@map("demo_comments")
}

// Tabela de atividades/audit log
model DemoActivity {
  id        String   @id @default(uuid())
  demoId    String
  demo      Demo     @relation(fields: [demoId], references: [id], onDelete: Cascade)
  userId    String?
  action    String
  changes   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([demoId])
  @@index([userId])
  @@index([action])
  @@index([createdAt(sort: Desc)])
  @@map("demo_activities")
}
