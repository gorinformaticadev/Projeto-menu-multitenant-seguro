generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id              String            @id @default(uuid())
  email           String            @unique
  cnpjCpf         String            @unique
  nomeFantasia    String
  nomeResponsavel String
  telefone        String
  logoUrl         String?
  ativo           Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  isMasterTenant  Boolean           @default(false)
  tenantModules   ModuleTenant[]
  users           User[]

  @@index([ativo])
  @@index([createdAt])
  @@index([isMasterTenant])
  @@map("tenants")
}

model User {
  id                       String               @id @default(uuid())
  email                    String               @unique
  password                 String
  name                     String
  role                     Role                 @default(USER)
  tenantId                 String?
  twoFactorSecret          String?
  twoFactorEnabled         Boolean              @default(false)
  emailVerified            Boolean              @default(false)
  emailVerificationToken   String?
  emailVerificationExpires DateTime?
  passwordHistory          String?
  lastPasswordChange       DateTime?
  loginAttempts            Int                  @default(0)
  isLocked                 Boolean              @default(false)
  lockedAt                 DateTime?
  lockedUntil              DateTime?
  lastFailedLoginAt        DateTime?
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  auditLogs                AuditLog[]
  passwordResetTokens      PasswordResetToken[]
  refreshTokens            RefreshToken[]
  blacklistedTokens        BlacklistedToken[]
  tenant                   Tenant?              @relation(fields: [tenantId], references: [id])
  preferences              UserPreferences?
  backupLogs               BackupLog[]
  backupRestoreLogs        BackupRestoreLog[]

  @@index([tenantId])
  @@index([email])
  @@index([role])
  @@index([isLocked])
  @@index([tenantId, role])
  @@map("users")
}

model UserPreferences {
  id        String   @id @default(uuid())
  userId    String   @unique
  theme     String   @default("light")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([userId, expiresAt])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("password_reset_tokens")
}

model BlacklistedToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("blacklisted_tokens")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  userId    String?
  tenantId  String?
  ipAddress String?
  userAgent String?
  details   String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
  @@index([tenantId, action, createdAt])
  @@index([userId, action, createdAt])
  @@map("audit_logs")
}

model SecurityConfig {
  id                         String   @id @default(uuid())
  loginMaxAttempts           Int      @default(5)
  loginLockDurationMinutes   Int      @default(30)
  loginWindowMinutes         Int      @default(1)
  globalMaxRequests          Int      @default(10000)
  globalWindowMinutes        Int      @default(1)
  passwordMinLength          Int      @default(8)
  passwordRequireUppercase   Boolean  @default(true)
  passwordRequireLowercase   Boolean  @default(true)
  passwordRequireNumbers     Boolean  @default(true)
  passwordRequireSpecial     Boolean  @default(true)
  accessTokenExpiresIn       String   @default("15m")
  refreshTokenExpiresIn      String   @default("7d")
  twoFactorEnabled           Boolean  @default(false)
  twoFactorRequired          Boolean  @default(false)
  twoFactorRequiredForAdmins Boolean  @default(false)
  twoFactorSuggested         Boolean  @default(true)
  emailVerificationRequired  Boolean  @default(false)
  emailVerificationLevel     String   @default("SOFT")
  passwordReuseLimit         Int      @default(5)
  sessionTimeoutMinutes      Int      @default(30)
  smtpUsername               String?
  smtpPassword               String?
  platformName               String?  @default("Sistema Multitenant")
  platformEmail              String?
  platformPhone              String?
  rateLimitDevEnabled        Boolean  @default(false)
  rateLimitProdEnabled       Boolean  @default(false)
  rateLimitDevRequests       Int      @default(10000)
  rateLimitProdRequests      Int      @default(10000)
  rateLimitDevWindow         Int      @default(1)
  rateLimitProdWindow        Int      @default(1)
  tokenCleanupEnabled        Boolean  @default(true)
  tokenCleanupIntervalHours  Int      @default(24)
  maxActiveSessionsPerUser   Int      @default(5)
  refreshTokenRotation       Boolean  @default(true)
  backupRateLimitPerHour     Int      @default(5)
  restoreRateLimitPerHour    Int      @default(3)
  updateRateLimitPerHour     Int      @default(2)
  updatedAt                  DateTime @updatedAt
  updatedBy                  String?

  @@map("security_config")
}

model EmailConfiguration {
  id           String   @id @default(uuid())
  providerName String
  smtpHost     String
  smtpPort     Int
  encryption   String
  authMethod   String
  isActive     Boolean  @default(false)
  createdBy    String?
  updatedBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("email_configurations")
}

model SystemSettings {
  id                 String    @id @default(uuid())
  appVersion         String?   @default("1.0.0")
  gitToken           String?
  gitUsername        String?
  gitRepository      String?
  gitReleaseBranch   String    @default("main")
  packageManager     String    @default("npm")
  updateCheckEnabled Boolean   @default(true)
  lastUpdateCheck    DateTime?
  availableVersion   String?
  updateAvailable    Boolean   @default(false)
  releaseTag         String?   @default("latest")
  composeFile        String?   @default("docker-compose.prod.yml")
  envFile            String?   @default("install/.env.production")
  updatedAt          DateTime  @updatedAt
  updatedBy          String?

  @@map("system_settings")
}

model UpdateLog {
  id             String    @id @default(uuid())
  version        String
  status         String
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  duration       Int?
  packageManager String    @default("npm")
  backupPath     String?
  errorMessage   String?
  rollbackReason String?
  executedBy     String?
  ipAddress      String?
  userAgent      String?
  executionLogs  String?

  @@index([status])
  @@index([startedAt])
  @@index([version])
  @@index([executedBy])
  @@map("update_logs")
}

model Module {
  id            String            @id @default(uuid())
  slug          String            @unique
  name          String
  version       String            @default("1.0.0")
  description   String?
  status        ModuleStatus      @default(detected)
  hasBackend    Boolean           @default(false)
  hasFrontend   Boolean           @default(false)
  installedAt   DateTime?
  activatedAt   DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  menus         ModuleMenu[]
  migrations    ModuleMigration[]
  tenantModules ModuleTenant[]

  @@index([status])
  @@index([slug])
  @@map("modules")
}

model ModuleMenu {
  id         String       @id @default(uuid())
  moduleId   String
  label      String
  icon       String?
  route      String
  parentId   String?
  order      Int          @default(0)
  permission String?
  isUserMenu Boolean      @default(true)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  module     Module       @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  parent     ModuleMenu?  @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children   ModuleMenu[] @relation("MenuHierarchy")

  @@index([moduleId])
  @@index([parentId])
  @@index([order])
  @@map("module_menus")
}

model ModuleTenant {
  id        String   @id @default(uuid())
  moduleId  String
  tenantId  String
  enabled   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([moduleId, tenantId])
  @@index([tenantId])
  @@index([moduleId])
  @@index([enabled])
  @@map("module_tenant")
}

model ModuleMigration {
  id         String        @id @default(uuid())
  moduleId   String
  filename   String
  type       MigrationType
  executedAt DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  module     Module        @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([moduleId, filename, type])
  @@index([moduleId])
  @@index([type])
  @@index([executedAt])
  @@map("module_migrations")
}

model Notification {
  id        String    @id @default(uuid())
  title     String
  message   String
  severity  String
  audience  String
  source    String
  module    String?
  tenantId  String?
  userId    String?
  context   String?
  data      Json      @default("{}")
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([tenantId])
  @@index([userId])
  @@index([audience])
  @@index([severity])
  @@index([source])
  @@index([module])
  @@index([read])
  @@index([createdAt])
  @@index([tenantId, audience, read])
  @@index([userId, read])
  @@map("notifications")
}

model SecureFile {
  id             String    @id @default(uuid())
  tenantId       String
  moduleName     String
  documentType   String
  originalName   String
  storedName     String
  mimeType       String
  sizeBytes      BigInt
  uploadedBy     String
  uploadedAt     DateTime  @default(now())
  lastAccessedAt DateTime?
  accessCount    Int       @default(0)
  deletedAt      DateTime?
  metadata       Json?

  @@index([tenantId])
  @@index([moduleName])
  @@index([uploadedBy])
  @@index([documentType])
  @@index([tenantId, moduleName, documentType])
  @@index([deletedAt])
  @@map("secure_files")
}

model CronSchedule {
  id            String   @id @default(uuid())
  origem        String
  modulo        String?
  identificador String
  descricao     String?
  expressao     String
  ativo         Boolean  @default(true)
  editavel      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([modulo, identificador])
  @@map("cron_schedules")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
  CLIENT
}

enum ModuleStatus {
  detected
  installed
  db_ready
  active
  disabled
}

enum MigrationType {
  migration
  seed
}

enum BackupOperation {
  BACKUP
  RESTORE
}

enum BackupStatus {
  STARTED
  SUCCESS
  FAILED
  CANCELLED
}

model BackupLog {
  id                String          @id @default(uuid())
  operationType     BackupOperation
  status            BackupStatus
  fileName          String
  fileSize          BigInt?
  startedAt         DateTime        @default(now())
  completedAt       DateTime?
  durationSeconds   Int?
  executedBy        String
  ipAddress         String?
  errorMessage      String?
  metadata          Json?
  user              User            @relation(fields: [executedBy], references: [id])

  @@index([operationType])
  @@index([status])
  @@index([executedBy])
  @@index([startedAt])
  @@map("backup_logs")
}

model BackupRestoreLog {
  id            String       @id @default(uuid())
  fileName      String
  status        RestoreStatus
  startedAt     DateTime     @default(now())
  completedAt   DateTime?
  stdout        String?
  stderr        String?
  executedBy    String
  rollbackReason String?
  errorMessage  String?
  metadata      Json?
  user          User         @relation(fields: [executedBy], references: [id])

  @@index([status])
  @@index([startedAt])
  @@index([executedBy])
  @@map("backup_restore_logs")
}

enum RestoreStatus {
  STARTED
  SUCCESS
  FAILED
}



