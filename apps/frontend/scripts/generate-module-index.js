const fs = require('fs');
const path = require('path');

const modulesDir = path.resolve(__dirname, '../../modules');
const outputDir = path.resolve(__dirname, '../src/lib');
const outputFile = path.join(outputDir, 'modules-registry.ts');

if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
}

const modules = [];

if (fs.existsSync(modulesDir)) {
    const dirs = fs.readdirSync(modulesDir);
    dirs.forEach(dir => {
        const routesPath = path.join(modulesDir, dir, 'frontend', 'routes.tsx');
        if (fs.existsSync(routesPath)) {
            console.log(`Found module with routes: ${dir}`);
            modules.push({
                name: dir,
                // Ajustar caminho relativo de src/lib para modules root
                importPath: `../../../../modules/${dir}/frontend/routes`
            });
        }
    });
}

let content = `// Auto-generated by scripts/generate-module-index.js\n`;
content += `// Do not edit manually\n\n`;

modules.forEach((mod) => {
    // Usar nome de variável seguro (remover traços)
    const varName = mod.name.replace(/[^a-zA-Z0-9]/g, '_');
    content += `import { ModuleRoutes as Routes_${varName} } from '${mod.importPath}';\n`;
});

content += `\nexport const AllModuleRoutes = [\n`;
modules.forEach((mod) => {
    const varName = mod.name.replace(/[^a-zA-Z0-9]/g, '_');
    content += `  ...Routes_${varName},\n`;
});
content += `];\n`;

fs.writeFileSync(outputFile, content);
console.log(`Registry generated at ${outputFile} with ${modules.length} modules.`);
